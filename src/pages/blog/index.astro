---
import BaseHead from '../../components/BaseHead.astro';
import Header from '../../components/Header.astro';
import Footer from '../../components/Footer.astro';
import BlogCard from '../../components/BlogCard.astro';
import { SITE_TITLE, SITE_DESCRIPTION } from '../../consts';
import { client } from '../../sanity/lib/client';
import { postsQuery } from '../../sanity/lib/queries';
import { urlForImage } from '../../sanity/lib/image';

// Fetch posts from Sanity
const posts = await client.fetch(postsQuery);

// Cache for 5 minutes, then revalidate
Astro.response.headers.set('Cache-Control', 'public, max-age=300, stale-while-revalidate=60');
Astro.response.headers.set('CDN-Cache-Control', 'public, max-age=300');

// Calculate read time
const calculateReadTime = (content: any) => {
  // Rough estimate based on content length
  return 5; // Default for now
};
---

<!doctype html>
<html lang="en">
  <head>
    <BaseHead title={`Blog - ${SITE_TITLE}`} description="Expert insights on SRE, AIOps, and reliability engineering" />
  </head>
  <body>
    <Header />
    <main class="min-h-screen bg-slate-900 pt-20">
      <div class="container mx-auto px-4 py-12">
        <!-- Header -->
        <div class="text-center mb-12">
          <h1 class="text-4xl md:text-5xl font-bold text-white mb-4">
            Reliability Engineering Insights
          </h1>
          <p class="text-xl text-slate-300 max-w-2xl mx-auto">
            Deep dives into SRE practices, AI-driven operations, and building resilient systems
          </p>
        </div>

        <!-- Posts Grid -->
        {posts.length > 0 ? (
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
            {posts.map((post) => (
              <BlogCard
                title={post.title}
                excerpt={post.excerpt}
                date={new Date(post.publishedAt)}
                slug={post.slug?.current || post.slug}
                readTime={post.readTime || calculateReadTime(post)}
                tags={post.categories || ['SRE', 'AI']}
              />
            ))}
          </div>
        ) : (
          <div class="text-center py-20">
            <div class="card-glass max-w-md mx-auto">
              <h2 class="text-2xl font-semibold text-white mb-4">No Posts Yet</h2>
              <p class="text-slate-300 mb-6">
                Create your first post in the Sanity Studio to see it here.
              </p>
              <a href="/studio" class="btn-primary">
                Go to Studio
                <svg class="w-5 h-5 ml-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7l5 5m0 0l-5 5m5-5H6"></path>
                </svg>
              </a>
            </div>
          </div>
        )}
      </div>
    </main>
    <Footer />
  </body>
</html>