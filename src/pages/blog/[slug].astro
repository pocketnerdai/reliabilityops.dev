---
import BlogPost from '../../layouts/BlogPost.astro';
import { client } from '../../sanity/lib/client';
import { postBySlugQuery } from '../../sanity/lib/queries';

const { slug } = Astro.params;
const post = await client.fetch(postBySlugQuery, { slug });

if (!post) {
  return Astro.redirect('/404');
}

// Cache individual posts for 1 hour
Astro.response.headers.set('Cache-Control', 'public, max-age=3600, stale-while-revalidate=300');
Astro.response.headers.set('CDN-Cache-Control', 'public, max-age=3600');

// Extract plain text from body for now
let bodyContent = '';
if (post.body && Array.isArray(post.body)) {
  bodyContent = post.body.map(block => {
    if (block._type === 'block' && block.children) {
      return block.children.map(child => child.text || '').join('');
    }
    return '';
  }).join('\n\n');
}

// Transform Sanity data to match BlogPost layout expectations
const postData = {
  title: post.title,
  description: post.excerpt,
  pubDate: new Date(post.publishedAt),
  heroImage: post.heroImage,
};
---

<BlogPost {...postData}>
  <div class="prose prose-lg prose-invert max-w-none">
    <div class="whitespace-pre-wrap text-slate-300">
      {bodyContent}
    </div>
  </div>
</BlogPost>